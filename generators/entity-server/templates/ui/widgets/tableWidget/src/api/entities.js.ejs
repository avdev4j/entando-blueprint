<%# { "useBluePrint": true, "renameTo": "`/${generator.entityInstance}/tableWidget/src/api/${generator.entityInstancePlural}.js`" } -%>
import { DOMAIN } from 'api/constants';
import { getFilterQuery } from 'components/filters/utils';

const getKeycloakToken = () => {
  if (
    window &&
    window.entando &&
    window.entando.keycloak &&
    window.entando.keycloak.authenticated
  ) {
    return window.entando.keycloak.token;
  }
  return '';
};

const getDefaultOptions = () => ({
  headers: new Headers({
    Authorization: `Bearer ${getKeycloakToken()}`,
    'Content-Type': 'application/json',
  }),
});

const request = async (url, options) => {
  const response = await fetch(url, options);

  const headers = {
    ...(response.headers.has('X-Total-Count')
      ? { 'X-Total-Count': parseInt(response.headers.get('X-Total-Count'), 10) }
      : {}),
  };

  return response.status >= 200 && response.status < 300
    ? { <%= entityInstancePlural %>: await response.json(), headers }
    : Promise.reject(new Error(response.statusText || response.status));
};

const getUrl = (url, filters = '', pagination = '') => {
  const hasQuery = !!(filters || pagination);
  const parameters = `${filters}${filters ? '&' : ''}${pagination}`;
  return `${url}${hasQuery ? `?${parameters}` : ''}`;
};

export const api<%= entityClassPlural %>Delete = async id => {
  const url = `${DOMAIN}/<%= entityApiUrl %>/${id}`;
  const options = {
    ...getDefaultOptions(),
    method: 'DELETE',
  };
  return request(url, options);
};

export const api<%= entityClassPlural %>Get = async ({ filters = [], pagination, mode }) => {
  const filterQuery = getFilterQuery(filters);

  const paginationQuery = pagination
    ? `page=${pagination.page}&size=${pagination.rowsPerPage}`
    : '';

  const url = getUrl(
    `${DOMAIN}/<%= entityApiUrl %>${mode === 'count' ? '/count' : ''}`,
    filterQuery,
    paginationQuery
  );

  const options = {
    ...getDefaultOptions(),
    method: 'GET',
  };
  return request(url, options);
};
